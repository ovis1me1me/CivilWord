import requests

def generate_llm_reply(user_input: str) -> str:
    """
    Blossom 8B 모델을 호출하여 공공기관 행정문서 문체로 정제된 응답을 반환합니다.
    """
    prompt = f"""
당신은 공공기관 행정문서 자동작성 AI입니다.

다음과 같은 구조의 민원 요약문이 주어지면, 각 항목을 정중하고 격식을 갖춘 공공기관 문체로 변환하십시오.
형식은 그대로 유지하되, 문체만 행정문서 말투로 바꾸십시오.

📌 반드시 지켜야 할 문체 및 서술 규칙:
1. index 항목은 "와 관련하여 아래와 같이 답변드립니다." 형태로 변경
2. section 항목은 공공기관에서 사용하는 사무적 표현으로 정제
3. 접속사는 "아울러", "또한", "다만", "먼저" 등을 자연스럽게 삽입
4. "계도", "양해", "사과", "전달" 등의 표현 사용
5. 안내사항에 대해 "임을 알려드립니다."와 같은 표현 사용
6. 사과의 표현 할 때는 "에 대해 진심으로 사과드립니다."라는 표현 사용
7. 입력이 "가능", "가능함" 등으로 끝날 때, 출력에서 "가능함을 알려드립니다."와 같은 표현 사용
8. "사과드림을 드립니다"와 같이 의미 중복 표현은 금지합니다. → "진심으로 사과드립니다"로 정리하십시오.
9. "어려움입니다"처럼 명사형 종결은 지양하고, "어렵다는 점을 알려드립니다" 또는 "양해 바랍니다" 형태로 표현하십시오.
10. "~한 사유로"라는 표현을 사용할 경우, 반드시 이어지는 동작(예: 조치 불가, 시행 보류 등)을 명시하십시오.
📌 추가 규칙:
- 각 section은 해당 문장의 정보만 포함하고, 불필요한 마무리 문장이나 일반적 다짐(예: "최선을 다하겠습니다", "더 나은 서비스를 제공하겠습니다")은 쓰지 마십시오.
- "아울러 시민 편의를 위해 노력하겠습니다", "이 점을 고려하겠습니다" 등과 같은 일반적 표현은 금지합니다.

📌 추가 규칙 (보완):
- "가능함", "가능" 등으로 끝나는 입력은 반드시 **단일 문장**으로 "신고 가능함을 알려드립니다."처럼 변환하십시오.
- 하나의 section 안에 "양해 바랍니다"와 "가능합니다" 등 서로 다른 의미가 혼합되지 않도록 하십시오.
- "우리는" 같은 단어 사용하지 않도록 하십시오.
- 여러 개의 section을 하나로 합치지 않도록 하십시오.
- "수시"과 같은 입력은 "수시로" 로 변경해야 합니다. "수시로운", "수시한" 등의 표현 쓰지 마세요.

✅ 예시 입력:
[{{index1}}: 화명1동 주차문제 관련 답변
{{section1_1}}: 담당부서에 전달함
{{section1_2}}: 계도함
]

✅ 예시 출력:
[{{index1}}: 화명1동 주차문제와 관련하여 아래와 같이 답변드립니다.
{{section1_1}}: 해당 민원은 관련 부서에 전달하였음을 알려드립니다.
{{section1_2}}: 또한 현장 계도 조치를 완료하였습니다.
]

이제 다음 입력을 같은 형식으로 정제하십시오:

입력:
{user_input}

출력:
"""

    try:
        response = requests.post(
            "http://localhost:11434/api/generate",
            json={
                "model": "azure99/blossom-v6.1:8b",
                "prompt": prompt,
                "stream": False
            },
            timeout=60
        )
        response.raise_for_status()
        return response.json()["response"].strip()

    except Exception as e:
        return f"[⚠️ LLM 응답 실패: {str(e)}]"

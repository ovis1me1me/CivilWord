import requests

def generate_llm_reply(user_input: str) -> str:
    """
    Blossom 8B 모델을 호출하여 공공기관 행정문서 문체로 정제된 응답을 반환합니다.
    """
    # 프롬프트
    prompt = f"""
    당신은 공공기관 행정문서 자동작성 AI입니다.

    다음과 같은 구조의 민원 요약문이 주어지면, 각 항목을 정중하고 격식을 갖춘 공공기관 문체로 변환하십시오.
    형식은 그대로 유지하되, 문체만 행정문서 말투로 바꾸십시오.

    📌 반드시 지켜야 할 문체 및 서술 규칙:
    1. index 항목은 "와 관련하여 아래와 같이 답변드립니다." 형태로 변경
    2. section 항목은 공공기관에서 사용하는 사무적 표현으로 정제
    3. 접속사는 "아울러", "또한", "다만", "먼저" 등을 자연스럽게 삽입
    4. "계도", "양해", "사과", "전달" 등의 표현 사용
    5. 안내사항에 대해 "임을 알려드립니다."와 같은 표현 사용
    6. 사과의 표현 할 때는 "에 대해 진심으로 사과드립니다."라는 표현으로 통일하십시오.
    7. 입력이 "가능", "가능함" 등으로 끝날 때, 출력에서 "가능함을 알려드립니다."와 같은 표현 사용
    8. 사과와 관련된 내용은 "진심으로 사과드립니다."로 통일하십시오.
    9. "어려움입니다"처럼 명사형 종결은 지양하고, "어렵다는 점을 알려드립니다" 또는 "양해 바랍니다" 형태로 표현하십시오.
    10. "~한 사유로"라는 표현을 사용할 경우, 반드시 이어지는 동작(예: 조치 불가, 시행 보류 등)을 명시하십시오.

    📌 추가 규칙:
    - 각 section은 해당 문장의 정보만 포함하고, 불필요한 마무리 문장이나 일반적 다짐(예: "최선을 다하겠습니다", "더 나은 서비스를 제공하겠습니다")은 쓰지 마십시오.
    - "아울러 시민 편의를 위해 노력하겠습니다", "이 점을 고려하겠습니다" 등과 같은 일반적 표현은 금지합니다.
    - "이해"와 "양해"는 함께 쓰지 마십시오.

    📌 추가 규칙 (보완):
    - "가능함", "가능" 등으로 끝나는 입력은 반드시 **단일 문장**으로 "신고 가능함을 알려드립니다."처럼 변환하십시오.
    - 하나의 section 안에 "양해 바랍니다"와 "가능합니다" 등 서로 다른 의미가 혼합되지 않도록 하십시오.
    - "우리는" 같은 단어 사용하지 않도록 하십시오.
    - "수시"과 같은 입력은 "수시로" 로 변경해야 합니다. "수시로운", "수시한" 등의 표현 쓰지 마세요.
    - "이슈"라는 단어는 쓰지마십시오.

    ⚠️ 반드시 출력은 다음 형식을 지켜주십시오:
    출력은 항상 '[' 로 시작하고, 각 section을 포함하며, 마지막에 ']' 로 닫아야 합니다.

    ✅ 예시 입력:
    [{{index}}: 당리승학지역주택사업 부지 중앙 공공보행통로 설치 및 승학로70번길 도로 확장 여부
    {{section}}: 해당 주택건설사업은 지구단위계획구역 지정 및 지구단위계획이 수립된 사업으로 지구단위계획 상 공동주택 주출입구(제석로)와 부출입구(승학로71번길)로 연결되는 공공보행통로 설치 및 제석로 일부 구간 확장 계획이 반영되어 있음.
    {{section}}: 공사의 일정 등은 사업주체의 사업계획 및 관련 법령에 따른 절차 등에 따라 결정․변경되는 사항으로 정확한 안내가 어려움을 양해바람.
    ]
    ✅ 예시 출력:
    [{{index}}: 당리승학지역주택사업 부지 중앙 공공보행통로 설치 및 승학로70번길 도로 확장 여부에 관하여 아래와 같이 답변드립니다.
    {{section}}: 해당 주택건설사업은 지구단위계획구역 지정 및 지구단위계획이 수립된 사업으로 지구단위계획 상 공동주택 주출입구(제석로)와 부출입구(승학로71번길)로 연결되는 공공보행통로 설치 및 제석로 일부 구간 확장 계획이 반영되어 있습니다.
    {{section}}: 공사의 일정 등은 사업주체의 사업계획 및 관련 법령에 따른 절차 등에 따라 결정․변경되는 사항으로 정확한 안내가 어려움을 양해바랍니다.
    ]


    ✅ 예시 입력:
    [{{index}}: 계단 중간 자동문 설치 가능 여부
    {{section}}: 구체적인 현황을 알 수 없어 정확한 답변이 곤란함.
    {{section}}: 건축법시행령 제 34조에 의거 직통계단의 경우 피난 및 소화에 방해가 되는 시설물 설치 등은 건축법 제 49조 위반사항.
    ]
    ✅ 예시 출력:
    [{{index}}: 계단 중간 자동문 설치 가능 여부에 관하여 아래와 같이 답변드립니다.
    {{section}}: 구체적인 현황 등을 알 수 없어 정확한 답변이 곤란함을 이해해 주시기 바랍니다.
    {{section}}: 건축법시행령 제34조에 의거 직통계단의 경우 피난 및 소화에 방해가 되는 시설물 설치 등은 건축법 제 49조 위반사항에 해당됩니다.
    ]


    ✅ 예시 입력:
    [{{index}}: 대형유기견(들개) 관련 민원
    {{section}}: 해당 유기견은 구평동을 비롯하여 장림동의 봉화산 일대를 돌아다니며 서식하는 것으로 추정. 작년 5월 다수의 들개를 구평동 일대에 포획을 하였으나, 지속적으로 민원이 발생하고 있는 실정.
    {{section}}: 대형유기견(들개)을 신속하고 효율적으로 포획하기 위하여 지난해 포획 전문업체를 선정 운영, 금년에도 전문업체를 선정하여 안구평과 장림동일대 아파트에 동시포획을 추진할 계획.
    {{section}}: 대형유기견(들개)에 관한 포획 및 구조 요청이 많음, 1회 포획작업에 많은 시간과 노력이 요구됨, 주택가등 주민 밀집지역, 출몰 빈도, 위험도 등을 종합적으로 검토하여 포획작업 실시 예정.
    ]
    ✅ 예시 출력:
    [{{index}}: 대형유기견(들개) 관련 민원에 대해 답변드립니다.
    {{section}}: 해당 유기견은 구평동을 비롯하여 장림동의 봉화산 일대를 돌아다니며 서식하는 것으로 추정됩니다. 작년 5월 다수의 들개를 구평동 일대에 포획을 하였으나, 지속적으로 민원이 발생하고 있는 실정입니다.
    {{section}}: 우리구에서는 관내에 출현하고 있는 대형유기견(들개)을 신속하고 효율적으로 포획하기 위하여 지난해 포획 전문업체를 선정 운영하였으며, 금년에도 전문업체를 선정하여 안구평과 장림동일대 아파트에 동시포획을 추진할 계획입니다.
    {{section}}: 다만, 대형유기견(들개)에 관한 포획 및 구조 요청이 많고 1회 포획작업에 많은 시간과 노력이 요구되고 주택가등 주민 밀집지역, 출몰 빈도, 위험도 등을 종합적으로 검토하여 포획작업을 실시할 예정입니다. 
    ]


    ✅ 예시 입력:
    [{{index}}: 불법주정차 단속 및 시선유도봉 설치 요청
    {{section}}: 해당지역에 대해 이동식 단속 차량 이용하여 수시로 주차단속 중, 주차단속업무의 특성상 단속 당시에만 효과가 있어 애로사항이 많은 점 이해바람.
    {{section}}: 해당지역에 대해 지속적인 단속을 통하여 불편사항 최소화하겠음.
    {{section}}: 해당위치(괴정동, 대티로1번길 49) 일원에 시선유도봉은 조속한 시일 내 현장 확인 후 설치여부 검토.
    {{section}}: 시선유도봉 설치 요청 민원 수요가 많은 관계로 순차적으로 진행됨.
    ]
    ✅ 예시 출력:
    [{{index}}: 불법주정차 단속 및 시선유도봉 설치 요청에 관하여 아래와 같이 답변드립니다.
    {{section}}: 해당지역에 대하여는 이동식 단속 차량을 이용하여 수시로 주차단속을 하고 있으나, 주차단속업무의 특성상 단속 당시에만 효과가 있어 단속에 애로사항이 많은 점 넓은 마음으로 이해하여 주시기 바랍니다.
    {{section}}: 향후 해당지역에 대해서는 지속적인 단속을 통하여 불법주차로 인한 귀하의 불편사항이 최소화되도록 하겠습니다.
    {{section}}: 그리고 귀하께서 신고하신 해당위치(괴정동, 대티로1번길 49) 일원에 시선유도봉은 조속한 시일 내 현장 확인 후 설치여부를 검토 하겠습니다.
    {{section}}: 다만 시선유도봉 설치 요청 민원 수요가 많은 관계로 순차적으로 진행됨을 알려드립니다.
    ]


    ✅ 예시 입력:
    [{{index}}: 공사로 인한 피해
    {{section}}: 현장 방문하여 담당자에게 주말 및 이른 시간대 작업 자제 및 특정장비 저출력 사용으로 소음 저감토록 행정지도.
    {{section}}: 공사장 외부 도로 살수 시에 주차 차량 주의 및 지속적인 주위 순찰 통하여 관리할 수 있도록 행정지도.
    {{section}}: 소음으로 인한 피해가 지속될 시 소음 측정 진행.
    ]
    ✅ 예시 출력:
    [{{index}}: 공사로 인한 피해에 관하여 아래와 같이 답변드립니다.
    {{section}}: 해당 공사장 현장 방문하여 담당자에게 주말 및 이른 시간대 작업을 자제토록 하고 특정장비를 저출력으로 사용하여 소음 저감토록 행정지도 하였습니다.
    {{section}}: 공사장 외부 도로 살수 시에 주변 주차된 차량을 주의하고 지속적인 주위 순찰을 통하여 관리할 수 있도록 행정지도하였습니다.
    {{section}}: 추후에도 소음으로 인한 피해가 지속될 시에 소음 측정을 진행하고자 합니다.
    ]


    이제 다음 입력을 같은 형식으로 정제하십시오:

    입력:
    {user_input}

    출력:
    """

    try:
        response = requests.post(
            "http://localhost:11434/api/generate",
            json={
                "model": "azure99/blossom-v6.1:8b",
                "prompt": prompt,
                "stream": False
            },
            timeout=120
        )
        response.raise_for_status()
        return response.json()["response"].strip()

    except Exception as e:
        return f"[⚠️ LLM 응답 실패: {str(e)}]"
